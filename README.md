# Golang Тестовое задание

Простая имплементация похожего на Redis кеша в памяти

## Необходимый функционал:
```
-- Key-value хранилище строк, списков, словарей
-- TTL на каждый ключ
-- Операторы
    --GET
    --SET
    --REMOVE
    --KEYS
-- Дополнительные операции (получить значение по индексу из списка,
    получить значение по ключу из словаря)
-- Golang API Client к кешу
-- API tcp(telnet)/REST API (реализовать одно на выбор)
```
Предоставить несколько тестов, документацию по API,
документацию по развертыванию, несколько кейсов
и примеров использования кеша вызовов http/tcp api.

## Не обязательные требования:
```
-- Сохранение на диск
-- Масштабирование (на серверной стороне, на клиентское выбирайте сами)
-- Авторизация
-- Нагрузочные тесты
```

## Golang API
Хранилище хранит объекты типа Value, содержащие поля:
```
expires int64
type int
data interface{}
```
Внешний интерфейс - Cache, поддерживающий следующие методы:
```
Set(key string, value interface{}, expire time.Duration) (*Value, error)
Get(key string) (*Value, error)
Remove(key string) (err error)
Keys() ([]string, error)
GetAtIndex(key string, index interface{}) (interface{}, error)
```
Для создания кэша необходимо вызвать метод NewCache,
принимающий параметры:
```
defaultTTL   time.Duration      - TTL, выставляемый ключу по умолчанию
out          io.Writer          - output для лога
rw           io.ReadWriter      - файл для восстановления кэша и
                                  записи в него
saveFreq     time.Duration      - частота записи в файл
nShards      int                - максимальное число шардов, в которые
                                  можно одновременно писать, по умолчанию 1
shardingFunc func(string)uint32 - хэш-функция, позволяющая определить в
                                  каком шарде должен храниться ключ.
                                  По умолчанию используется
                                  Sum от 32-bit FNV-1a
```
## REST HTTP приложение
Для запуска HTTP сервера нужно выполнить метод Run класса App.
Перед запуском сервера нужно проинициализировать инстанс App методом
Initialize(), который принимает на вход те же параметры, что и NewCache.
При инициализации приложение создаст кэши и http handler'ы
Метод Run принимает:
```
addr         string - host+port, которые будет слушать http сервер
readTimeout  int    - timeout чтения в секундах
writeTimeout int    - timeout записи в секундах
```
В качестве роутера используется gorilla/mux
## REST API
REST API принимает и возвращает данные в формате JSON

При отправке TTL передаваемое значение должно быть строкой, правильно
воспринимаемой методом time.ParseDuration()

При успешном запросе возвращается HTTP код 200, при ошибке на стороне
приложения - 400

| Метод                 | Глагол | Url          | Body                                                         | Пример успешного ответаa                                                                | Пример ошибки                                                    |
|-----------------------|--------|--------------|--------------------------------------------------------------|-----------------------------------------------------------------------------------------|------------------------------------------------------------------|
| Keys                  | GET    | /            | --                                                           | ["string","map","my_key"]                                                               | --                                                               |
| Get                   | GET    | /key         | --                                                           | {"type": 1,"data": [1,"string",{"map": "of_something"},0.2,null,["nested","list",42,]]} | {"error": "key not found"}                                       |
| Get at index          | GET    | /key/index   | --                                                           | {"inner": {"one_more": {"key": "value"}}}                                               | {"error": "cant get item at index"}                              |
| Remove                | DELETE | /key         | --                                                           | "OK"                                                                                    | --                                                               |
| Set с ttl по умолчнию | POST   | /key         | {"a":42,"list":[1,{"hello":"world"}],"something":"anything"} | {"type":2,"data":{"a":42,"list":[1,{"hello":"world"}],"something":"anything"}}          | {"error":"invalid character 'a' looking for beginning of value"} |
| Set с ttl             | POST   | /key?ttl=10s | {"a":42,"list":[1,{"hello":"world"}],"something":"anything"} | {"type":2,"data":{"a":42,"list":[1,{"hello":"world"}],"something":"anything"}}          | {"error":"Malformed duration"}                                   |

## REST HTTP client
Реализует интерфейс Cache. Создается методом NewClient, который требует url сервера
REST API, таймаут соединения и логин/пароль для базовой авторизации (если она нужна)
## Развертывание
```
go get -u github.com/philippmachs/machsdb
```
На примере main
1. Выполнить go run main.go
2. Использовать REST API на localhost:8080

Либо
1. Выполнить команду go build main.go
2. Запустить полученный файл
3. Использовать REST API на localhost:8080
4. Доступные флаги и значения по умолчанию можно посмотреть, выполнив файл с флагом -h

На примере docker контейнера:
1. Выполнить makefile. Можно передать переменные GOOS, GOARCH, CGO_ENABLED. При этом будет создан контейнер kv_cache
2. Флаги запуска и переменные окружения можно отредактировать в файле .env
3. С настройками "по умолчанию" контейнер будет писать файл базы в ~/ хоста
4. Выполнить docker-compose up
5. Использовать REST API на localhost:8080
## Масштабирование
Пакет предоставляет функцию Shard, которая принимает на вход хэш-функцию
 и несколько объектов, реализующих интерфейс Cache, и распределяет
 вызова к ним в зависимости от соответствия ключ-хэш. Также принимает
 булевый флаг needLock, в зависимости от которого он будет использовать
 Read/Writ lock при обращении к ресурсу либо нет.
